<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XHS å†…å®¹çŸ©é˜µ (AIç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // --- é…ç½® Tailwind ---
        tailwind.config = {
            darkMode: 'class', // å¯ç”¨ 'class' ç­–ç•¥è¿›è¡Œæš—é»‘æ¨¡å¼åˆ‡æ¢
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#10B981', // æ´»åŠ›ç»¿ (æš—)
                        'primary-light': '#047857', // æ²‰ç¨³æ·±ç»¿ (äº®)
                    },
                    ringColor: {
                        'primary-dark': '#10B981',
                        'primary-light': '#047857',
                    },
                    animation: {
                        'pulse-green-dark': 'pulse-dark 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pulse-green-light': 'pulse-light 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'pulse-dark': {
                            '0%, 100%': { opacity: 1, backgroundColor: '#10B981' },
                            '50%': { opacity: .5, backgroundColor: '#059669' },
                        },
                        'pulse-light': {
                            '0%, 100%': { opacity: 1, backgroundColor: '#047857' },
                            '50%': { opacity: .5, backgroundColor: '#059669' },
                        },
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', 'PingFang SC', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        * {
            transition: background-color 0.2s ease-out, color 0.2s ease-out, border-color 0.2s ease-out;
        }
        /* å…è®¸æ»šåŠ¨æ¡ (ç”¨äºå“åº”å¼) */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>

<!-- 
  ä¸»ä½“ Body
  - ä¼˜åŒ–å“åº”å¼ï¼šç§»é™¤äº† overflow-hidden
-->
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">

    <!-- 
      ä¸»å®¹å™¨: åŒæ å¸ƒå±€
      - ä¼˜åŒ–å“åº”å¼: flex-col (ç§»åŠ¨ç«¯å †å ) md:flex-row (æ¡Œé¢ç«¯å¹¶æ’)
    -->
    <div class="flex flex-col md:flex-row min-h-screen">

        <!-- ========================== -->
        <!-- å·¦æ ï¼šæ§åˆ¶å° (Control Panel) -->
        <!-- ========================== -->
        <!-- 
          ä¼˜åŒ–å“åº”å¼: 
          - w-full (ç§»åŠ¨ç«¯å…¨å®½) md:w-1/3 lg:w-1/4 (æ¡Œé¢ç«¯ä¾§æ )
          - md:h-screen (æ¡Œé¢ç«¯å…¨é«˜)
          - border-b (ç§»åŠ¨ç«¯åº•è¾¹æ¡†) md:border-b-0 md:border-r (æ¡Œé¢ç«¯å³è¾¹æ¡†)
        -->
        <aside class="w-full md:w-1/3 lg:w-1/4 flex-shrink-0 flex flex-col p-6 bg-white dark:bg-gray-900 border-b md:border-b-0 md:border-r border-gray-300 dark:border-gray-700 shadow-lg md:h-screen overflow-y-auto">
            
            <!-- 1. é¡¶éƒ¨ï¼šæ ‡é¢˜å’Œä¸»é¢˜åˆ‡æ¢ -->
            <div class="flex items-center justify-between mb-6 flex-shrink-0">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                    XHS Content Matrix
                </h1>
                <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 ring-primary-light dark:ring-primary-dark">
                    <svg id="theme-icon-dark" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>

            <!-- æ»šåŠ¨å®¹å™¨ (ç§»åŠ¨ç«¯éœ€è¦) -->
            <div class="flex-grow flex flex-col">
                <!-- 2. äº§å“é€‰æ‹© (ProductSelector) -->
                <div class="mb-4">
                    <label for="product-select" class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-1">
                        1. é€‰æ‹©äº§å“ (8ä¸ª)
                    </label>
                    <select id="product-select" class="w-full p-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md shadow-sm focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark focus:border-transparent">
                        <option value="" disabled selected>è¯·é€‰æ‹©ä¸€ä¸ªäº§å“...</option>
                        <!-- é€‰é¡¹å°†ç”± JS åŠ¨æ€å¡«å…… -->
                    </select>
                </div>

                <!-- 3. è§’åº¦é€‰æ‹© (AngleSelector) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-2">
                        2. é€‰æ‹©æ–‡æ¡ˆè§’åº¦
                    </label>
                    <div id="angle-container" class="flex flex-wrap gap-2">
                        <button data-angle="story" class="angle-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">æ•…äº‹å‘</button>
                        <button data-angle="review" class="angle-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">æµ‹è¯„å‘</button>
                        <button data-angle="dry_goods" class="angle-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">å¹²è´§å‘</button>
                        <button data-angle="pain_point" class="angle-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">ç—›ç‚¹å‘</button>
                        <button data-angle="education" class="angle-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">æ•™è‚²å‘</button>
                    </div>
                </div>

                <!-- 4. ç”ŸæˆæŒ‰é’® (GenerateButton) -->
                <div class="mt-auto"> <!-- æ¨åˆ°åº•éƒ¨ -->
                    <button id="generate-btn" class="w-full text-lg font-bold py-3 px-4 rounded-md shadow-lg transition-all duration-150 ease-in-out
                                bg-primary-light hover:bg-green-600 text-white
                                dark:bg-primary-dark dark:hover:bg-green-400 dark:text-black
                                focus:outline-none focus:ring-4 focus:ring-primary-light dark:focus:ring-primary-dark
                                disabled:bg-gray-300 dark:disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed">
                        <span id="btn-text">ğŸš€ AI æ™ºèƒ½ç”Ÿæˆ</span>
                        <!-- åŠ è½½ä¸­ (Pulse) åŠ¨ç”» -->
                        <span id="btn-loading" class="hidden w-full h-full animate-pulse-green-light dark:animate-pulse-green-dark">
                            AI æ€è€ƒä¸­...
                        </span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ========================== -->
        <!-- å³æ ï¼šç»“æœå±•ç¤º (Generation Zone) -->
        <!-- ========================== -->
        <!-- 
          ä¼˜åŒ–å“åº”å¼: 
          - w-full (ç§»åŠ¨ç«¯å…¨å®½) md:w-2/3 lg:w-3/4 (æ¡Œé¢ç«¯ä¸»å†…å®¹)
          - md:h-screen (æ¡Œé¢ç«¯å…¨é«˜)
          - overflow-y-auto (ç‹¬ç«‹æ»šåŠ¨)
        -->
        <main class="w-full md:w-2/3 lg:w-3/4 flex flex-col p-6 md:p-10 bg-gray-50 dark:bg-gray-800 md:h-screen overflow-y-auto">
            
            <!-- å ä½ç¬¦ (Placeholder) -->
            <div id="placeholder" class="m-auto text-center text-gray-500 dark:text-gray-400">
                <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h2 class="mt-2 text-lg font-medium">// ç­‰å¾…ç”Ÿæˆ</h2>
                <p class="mt-1 text-sm">åœ¨å·¦ä¾§é€‰æ‹©äº§å“å’Œè§’åº¦åç‚¹å‡»ç”Ÿæˆ...</p>
            </div>

            <!-- ç»“æœå±•ç¤ºåŒº (é»˜è®¤éšè—) -->
            <div id="results" class="hidden h-full flex flex-col">
                
                <!-- å¤åˆ¶æŒ‰é’® -->
                <div class="flex-shrink-0 mb-4 text-right">
                    <button id="copy-btn" class="
                        px-4 py-2 text-sm font-medium rounded-md border
                        border-primary-light text-primary-light hover:bg-primary-light hover:text-white
                        dark:border-primary-dark dark:text-primary-dark dark:hover:bg-primary-dark dark:hover:text-black
                        focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark
                    ">
                        å¤åˆ¶å…¨éƒ¨å†…å®¹
                    </button>
                </div>
                
                <!-- æ ‡é¢˜ -->
                <div class="flex-shrink-0 mb-4">
                    <label for="result-title" class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-1">
                        AI ç”Ÿæˆæ ‡é¢˜
                    </label>
                    <textarea 
                        id="result-title" 
                        rows="2" 
                        class="w-full p-3 font-mono text-lg rounded-md shadow-sm 
                               border border-gray-300 dark:border-gray-700 
                               bg-white dark:bg-gray-900 
                               text-primary-light dark:text-primary-dark 
                               focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark focus:border-transparent"
                    ></textarea>
                </div>

                <!-- æ­£æ–‡ -->
                <div class="flex-grow flex flex-col">
                    <label for="result-body" class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-1">
                        AI ç”Ÿæˆæ­£æ–‡ (å«Tags)
                    </label>
                    <textarea 
                        id="result-body" 
                        class="w-full h-full flex-grow p-3 font-mono rounded-md shadow-sm 
                               border border-gray-300 dark:border-gray-700 
                               bg-white dark:bg-gray-900 
                               text-primary-light dark:text-primary-dark 
                               focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark focus:border-transparent"
                    ></textarea>
                </div>
            </div>

        </main>
    </div>

    <!-- ========================== -->
    <!-- JavaScript é€»è¾‘ -->
    <!-- ========================== -->
    <script>
        // --- 1. AI é›†æˆï¼šGemini API é…ç½® ---
        const apiKey = ""; // ç•™ç©ºï¼Œå°†è‡ªåŠ¨æ³¨å…¥
        const apiModel = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${apiModel}:generateContent?key=${apiKey}`;

        // AI ç³»ç»Ÿæç¤ºè¯
        const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ªé¡¶å°–çš„å°çº¢ä¹¦æ–‡æ¡ˆä¸“å®¶ï¼Œå°¤å…¶æ“…é•¿ä¸ºç•™å­¦ç”Ÿå’ŒèŒåœºæ–°äººæ’°å†™â€œæœ‹å‹åˆ†äº«â€å£å»çš„ç§è‰æ–‡æ¡ˆã€‚
ä½ çš„é£æ ¼æ˜¯çƒ­æƒ…ã€çœŸè¯šã€æœ‰æ„ŸæŸ“åŠ›çš„ï¼Œåƒé—ºèœœä¸€æ ·åœ¨èŠå¤©ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„â€œäº§å“ä¿¡æ¯â€ã€â€œæ ¸å¿ƒå–ç‚¹â€å’Œâ€œæ–‡æ¡ˆè§’åº¦â€æ¥åˆ›ä½œå†…å®¹ã€‚

è§„åˆ™ï¼š
1. å¤§é‡ä½¿ç”¨ emoji æ¥å¢åŠ æ–‡æ¡ˆçš„ç”ŸåŠ¨æ€§å’Œå¯è¯»æ€§ã€‚
2. æ–‡æ¡ˆç»“å°¾å¿…é¡»åŒ…å« 5-7 ä¸ªç›¸å…³çš„å°çº¢ä¹¦ #hashtagsã€‚
3. ä½ çš„å›å¤**å¿…é¡»**ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™çš„è§£é‡Šå’Œå¯’æš„ï¼š
æ ‡é¢˜ï¼š[è¿™é‡Œæ˜¯æ–‡æ¡ˆæ ‡é¢˜]

æ­£æ–‡ï¼š[è¿™é‡Œæ˜¯æ–‡æ¡ˆæ­£æ–‡ï¼ŒåŒ…å«emojiå’Œhashtags]
`;

        // --- 2. å‡çº§ç‰ˆæ¨¡æ‹Ÿæ•°æ® (åŸºäºæ‚¨ä¸Šä¼ çš„ .txt æ–‡ä»¶) ---
        const mockProducts = [
            { 
                id: "p0", 
                name: "ç¤¾æç¨‹åº¦ä¸“ä¸šæµ‹è¯„ç³»ç»Ÿ",
                description: "åŸºäºå›½é™…æƒå¨SASç¤¾äº¤ç„¦è™‘é‡è¡¨ï¼Œå¸®ä½ å‡†ç¡®äº†è§£è‡ªå·±çš„ç¤¾äº¤çŠ¶æ€ã€‚",
                sellingPoints: ["35é“ç²¾å¿ƒè®¾è®¡çš„é¢˜ç›®", "8ä¸ªæ ¸å¿ƒç»´åº¦", "ä¸“å±ç¤¾æç±»å‹ç”»åƒå’Œè¯¦ç»†è§£è¯»", "5åˆ†é’Ÿå®Œæˆï¼Œ1ç§’ç”ŸæˆæŠ¥å‘Š", "æä¾›é’ˆå¯¹æ€§æ”¹å–„æ–¹æ¡ˆ"]
            },
            { 
                id: "p1", 
                name: "æ‰˜ç¦çœŸé¢˜ (æ›´æ–°è‡³2025.11.08)",
                description: "è€ƒæ‰˜å…¨å¥—è‡ªå­¦èµ„æ–™ï¼ŒåŒ…æ›´æ–°6ä¸ªæœˆã€‚",
                sellingPoints: ["çœŸé¢˜æ›´æ–°è‡³2025.11.08", "å¬åŠ›å¸¦é‡å¬é¢˜+éŸ³é¢‘+åŸæ–‡", "é˜…è¯»æ”¯æŒé¢˜ç›®æœç´¢", "å†™ä½œå’Œå£è¯­å¸¦èŒƒæ–‡", "èµ é€TPO1-75å…¨å¥—", "èµ é€æ¨¡æ‹Ÿè½¯ä»¶(win&mac)"]
            },
            { 
                id: "p2", 
                name: "72å¥— åŠ¨æ€PPTæ¨¡æ¿",
                description: "é«˜çº§åŠ¨æ•ˆï¼Œæ•ˆæœä¸æ»‘ã€‚",
                sellingPoints: ["å…±72å¥—", "æ¯å¥—1-15é¡µ", "åŠ¨æ€æ•ˆæœä¸æ»‘", "å¯ä»¥è‡ªå·±æ›¿æ¢å›¾ç‰‡æ–‡å­—", "æ‹ä¸‹å³å‘"]
            },
            { 
                id: "p3", 
                name: "2026æ‰˜ç¦13å¥—çœŸé¢˜ (æ”¹é©ç‰ˆ)",
                description: "é’ˆå¯¹2026æ”¹é©æ–°é¢˜ï¼Œå«ç­”æ¡ˆéŸ³é¢‘ã€‚",
                sellingPoints: ["6å¥—TPO-Packè¯•é¢˜", "4å¥—å­¦ç”Ÿ/è€å¸ˆæ ·é¢˜", "3å¥—çº¿ä¸‹ä½“éªŒæ—¥è¯•é¢˜", "å‡ä¸ºæ”¹é©æ–°é¢˜", "èµ é€æ‰˜ç¦è¯æ±‡å¤§ç¤¼åŒ…"]
            },
            { 
                id: "p4", 
                name: "è«æ²«114åˆ†èµ„æ–™åº“",
                description: "å­¦å§è‡ªç”¨ï¼Œä»79åˆ†åˆ°114åˆ†çš„30+æ ¸å¿ƒæ–‡ä»¶ã€‚",
                sellingPoints: ["å­¦ç§‘å•è¯(èƒŒ5-6é)", "é­”é¬¼ç²¾å¬æ³•(ä¸¤å‘¨è§æ•ˆ)", "11ç§é¢˜å‹åšé¢˜æŠ€å·§", "è«æ²«ç¬”è®°æµ(æ”»å…‹å°ç»“é¢˜)", "Vinceå­¦æœ¯å†™ä½œæ¨¡æ¿", "Fionaå£è¯­æ¨¡æ¿", "æ ‡æ³¨äº†ä½¿ç”¨é¡ºåºå’Œæ–¹æ³•"]
            },
            { 
                id: "p5", 
                name: "UnLock ç¬¬ä¸‰ç‰ˆæ•™æ (1-5çº§å…¨å¥—)",
                description: "2025æœ€æ–°ç¬¬ä¸‰ç‰ˆï¼Œå¸¦ç­”æ¡ˆã€‚",
                sellingPoints: ["1-5çº§å…¨å¥—", "å­¦ç”Ÿç”¨ä¹¦+æ•™å¸ˆç”¨ä¹¦", "å¸¦å…¨å¥—éŸ³é¢‘+è§†é¢‘", "å¸¦å•è¯è¡¨å’Œmodelç­”æ¡ˆ", "PDFæ–‡å­—ç²¾å‡†å¤åˆ¶"]
            },
            { 
                id: "p6", 
                name: "å‰‘æ¡¥unlockæ•™æ (å…¨å¥—å¸¦è¯¾ä»¶)",
                description: "basic-level5 å…±6ä¸ªçº§åˆ«ï¼Œå¸¦å¤–æ•™è¯¾ã€‚",
                sellingPoints: ["å­¦ç”Ÿç”¨ä¹¦+æ•™å¸ˆç”¨ä¹¦", "éŸ³é¢‘+è§†é¢‘+ç™½æ¿è½¯ä»¶", "PPTè¯¾ä»¶(1-4)", "å•å…ƒæµ‹è¯•+æœŸä¸­æœŸæœ«", "L1-L3å¤–æ•™è§†é¢‘è¯¾"]
            },
            { 
                id: "p7", 
                name: "ç¬¬ä¸‰ç‰ˆå›½å®¶åœ°ç†Reading Explorer",
                description: "REä¸‰ç‰ˆç²¾è®²è¯¾ï¼Œå…¨å¥—6çº§åˆ«ã€‚",
                sellingPoints: ["F-5å…±6ä¸ªçº§åˆ«", "å­¦ç”Ÿä¹¦+æ•™å¸ˆä¹¦+ç²¾è®²è¯¾è§†é¢‘", "ä¹å­¦æ— å¿§/joshua/çŒ«åˆ€ç­‰å¤šä¸ªå¤–æ•™è¯¾", "è¯æ±‡æ‹“å±•+è¯­æ³•å·©å›º+é˜…è¯»æŠ€å·§", "å›½å®¶åœ°ç†è§†é¢‘æ‹“å±•è§†é‡"]
            }
        ];

        // --- çŠ¶æ€å˜é‡ ---
        let selectedAngle = '';
        let selectedProductId = '';
        let isLoading = false;

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const dom = {
            html: document.documentElement,
            themeToggle: document.getElementById('theme-toggle'),
            iconDark: document.getElementById('theme-icon-dark'),
            iconLight: document.getElementById('theme-icon-light'),
            productSelect: document.getElementById('product-select'),
            angleContainer: document.getElementById('angle-container'),
            angleBtns: document.querySelectorAll('.angle-btn'),
            generateBtn: document.getElementById('generate-btn'),
            btnText: document.getElementById('btn-text'),
            btnLoading: document.getElementById('btn-loading'),
            placeholder: document.getElementById('placeholder'),
            results: document.getElementById('results'),
            resultTitle: document.getElementById('result-title'),
            resultBody: document.getElementById('result-body'),
            copyBtn: document.getElementById('copy-btn')
        };

        // --- 3. ä¸»é¢˜åˆ‡æ¢é€»è¾‘ ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                dom.html.classList.add('dark');
                dom.iconDark.classList.remove('hidden'); // æ˜¾ç¤ºå¤ªé˜³
                dom.iconLight.classList.add('hidden'); // éšè—æœˆäº®
            } else {
                dom.html.classList.remove('dark');
                dom.iconDark.classList.add('hidden'); // éšè—å¤ªé˜³
                dom.iconLight.classList.remove('hidden'); // æ˜¾ç¤ºæœˆäº®
            }
        }

        dom.themeToggle.addEventListener('click', () => {
            const currentTheme = dom.html.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœ¬åœ°å­˜å‚¨
        // ä¼˜åŒ–ï¼šé»˜è®¤ä½¿ç”¨ 'light' æ¨¡å¼ï¼Œä»¥å±•ç¤ºæ·±ç»¿è‰² UI
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);


        // --- 4. å¡«å……äº§å“ä¸‹æ‹‰æ¡† ---
        function populateProducts() {
            mockProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                dom.productSelect.appendChild(option);
            });
        }
        dom.productSelect.addEventListener('change', (e) => {
            selectedProductId = e.target.value;
            checkFormState();
        });


        // --- 5. è§’åº¦é€‰æ‹©é€»è¾‘ ---
        dom.angleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                dom.angleBtns.forEach(b => {
                    b.classList.remove('bg-primary-light', 'dark:bg-primary-dark', 'text-white', 'dark:text-black');
                    b.classList.add('bg-gray-200', 'dark:bg-gray-700');
                });
                
                btn.classList.add('bg-primary-light', 'dark:bg-primary-dark', 'text-white', 'dark:text-black');
                btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                
                selectedAngle = btn.dataset.angle;
                checkFormState();
            });
        });


        // --- 6. æ£€æŸ¥è¡¨å•çŠ¶æ€ (å¯ç”¨/ç¦ç”¨æŒ‰é’®) ---
        function checkFormState() {
            if (selectedProductId && selectedAngle && !isLoading) {
                dom.generateBtn.disabled = false;
            } else {
                dom.generateBtn.disabled = true;
            }
        }
        checkFormState(); // åˆå§‹æ£€æŸ¥


        // --- 7. (æ–°) API è¯·æ±‚ä¸é‡è¯• (fetchWithRetry) ---
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response.json();
                    }
                    // è‡ªåŠ¨å¤„ç† 429 (Too Many Requests) ç­‰å¯é‡è¯•é”™è¯¯
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`Retryable error: ${response.status}`);
                    }
                    // å¯¹äº 400/404 ç­‰å®¢æˆ·ç«¯é”™è¯¯ï¼Œç›´æ¥æŠ›å‡ºï¼Œä¸é‡è¯•
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API è¯·æ±‚å¤±è´¥');

                } catch (error) {
                    if (i === retries - 1) throw error; // æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        // --- 8. (æ–°) AI ç”Ÿæˆæ–‡æ¡ˆé€»è¾‘ ---
        async function generateCopy() {
            if (!selectedProductId || !selectedAngle) return;

            // a. è¿›å…¥åŠ è½½çŠ¶æ€
            isLoading = true;
            checkFormState();
            dom.btnText.classList.add('hidden');
            dom.btnLoading.classList.remove('hidden');
            dom.results.classList.add('hidden');
            dom.placeholder.classList.remove('hidden');
            dom.resultTitle.value = ""; // æ¸…ç©ºä¸Šæ¬¡ç»“æœ
            dom.resultBody.value = ""; // æ¸…ç©ºä¸Šæ¬¡ç»“æœ

            try {
                // b. å‡†å¤‡ API è¯·æ±‚
                const product = mockProducts.find(p => p.id === selectedProductId);
                if (!product) throw new Error("æœªæ‰¾åˆ°äº§å“æ•°æ®");
                
                const angleText = dom.angleContainer.querySelector(`[data-angle="${selectedAngle}"]`).textContent;

                // ç»„è£…ç”¨æˆ·æç¤ºè¯
                const userQuery = `
è¯·ä¸ºæˆ‘ç”Ÿæˆä¸€ç¯‡å°çº¢ä¹¦æ–‡æ¡ˆï¼š
- äº§å“åç§°ï¼š${product.name}
- äº§å“æè¿°ï¼š${product.description}
- æ ¸å¿ƒå–ç‚¹ï¼š${product.sellingPoints.join('ï¼Œ')}
- æ–‡æ¡ˆè§’åº¦ï¼š${angleText}
`;

                const payload = {
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    contents: [
                        { parts: [{ text: userQuery }] }
                    ]
                };

                // c. å‘é€ API è¯·æ±‚ (å¸¦é‡è¯•)
                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // d. è§£æ AI å›å¤
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    throw new Error("AI æœªè¿”å›æœ‰æ•ˆå†…å®¹");
                }

                // e. ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ‹†åˆ†æ ‡é¢˜å’Œæ­£æ–‡
                const titleMatch = text.match(/æ ‡é¢˜ï¼š(.*?)\n/);
                const bodyMatch = text.match(/æ­£æ–‡ï¼š([\s\S]*)/);

                let title = `AI ç”Ÿæˆæ ‡é¢˜ (æœªåŒ¹é…åˆ°æ ¼å¼)`;
                let body = text; // é»˜è®¤æ˜¾ç¤ºå…¨éƒ¨å†…å®¹

                if (titleMatch && titleMatch[1]) {
                    title = titleMatch[1].trim();
                }
                if (bodyMatch && bodyMatch[1]) {
                    body = bodyMatch[1].trim();
                }

                // f. æ˜¾ç¤ºç»“æœ
                dom.resultTitle.value = title;
                dom.resultBody.value = body;
                dom.placeholder.classList.add('hidden');
                dom.results.classList.remove('hidden');
                dom.results.classList.add('flex'); // ç¡®ä¿ flex ç”Ÿæ•ˆ

            } catch (error) {
                console.error('AI ç”Ÿæˆå¤±è´¥:', error);
                alert(`AI ç”Ÿæˆå¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– API é…ç½®ã€‚`);
                dom.resultBody.value = `ç”Ÿæˆå¤±è´¥ï¼š\n${error.message}\n\nè¯·é‡è¯•...`;
                dom.placeholder.classList.add('hidden');
                dom.results.classList.remove('hidden');
                dom.results.classList.add('flex');
            } finally {
                // g. é€€å‡ºåŠ è½½çŠ¶æ€
                isLoading = false;
                checkFormState();
                dom.btnText.classList.remove('hidden');
                dom.btnLoading.classList.add('hidden');
            }
        }
        
        // ç»‘å®šæ–°çš„ AI ç”Ÿæˆå‡½æ•°
        dom.generateBtn.addEventListener('click', generateCopy);


        // --- 9. å¤åˆ¶åˆ°å‰ªè´´æ¿ ---
        dom.copyBtn.addEventListener('click', () => {
            const fullText = `æ ‡é¢˜ï¼š${dom.resultTitle.value}\n\n${dom.resultBody.value}`;
            
            navigator.clipboard.writeText(fullText).then(() => {
                const originalText = dom.copyBtn.textContent;
                dom.copyBtn.textContent = 'å¤åˆ¶æˆåŠŸ!';
                dom.copyBtn.classList.add('text-green-500', 'dark:text-green-400');
                setTimeout(() => {
                    dom.copyBtn.textContent = originalText;
                    dom.copyBtn.classList.remove('text-green-500', 'dark:text-green-400');
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥: ', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
            });
        });

        // --- å¯åŠ¨ ---
        populateProducts();

    </script>
</body>
</html>