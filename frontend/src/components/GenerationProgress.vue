<template>
  <div class="flex flex-col items-center justify-center p-8 space-y-6 bg-white dark:bg-gray-900">
    <!-- æ ‡é¢˜ -->
    <div class="text-center">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
        {{ isMultiRound ? 'ğŸ¤– å¤šè½®AIä¼˜åŒ–ç”Ÿæˆä¸­' : 'ğŸ¤– AIæ™ºèƒ½ç”Ÿæˆä¸­' }}
      </h2>
      <p class="text-sm text-gray-500 dark:text-gray-400">
        {{ isMultiRound ? 'æ­£åœ¨è¿›è¡Œä¸‰è½®AIåä½œä¼˜åŒ–ï¼Œè¯·ç¨å€™...' : 'æ­£åœ¨è°ƒç”¨AIç”Ÿæˆå†…å®¹ï¼Œè¯·ç¨å€™...' }}
      </p>
    </div>

    <!-- å¤šè½®ä¼˜åŒ–æ­¥éª¤å±•ç¤º -->
    <div v-if="isMultiRound" class="w-full max-w-2xl space-y-4">
      <!-- ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆåˆå§‹å†…å®¹ -->
      <div class="flex items-start space-x-4 p-4 rounded-lg transition-all duration-300"
           :class="currentStep >= 1 ? 'bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-700' : 'bg-gray-50 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700'">
        <div class="flex-shrink-0 mt-1">
          <div v-if="currentStep > 1" class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div v-else-if="currentStep === 1" class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
            <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          </div>
          <div v-else class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
            <span class="text-white font-bold">1</span>
          </div>
        </div>
        <div class="flex-1">
          <h3 class="text-base font-semibold mb-1"
              :class="currentStep >= 1 ? 'text-blue-900 dark:text-blue-200' : 'text-gray-500 dark:text-gray-400'">
            ğŸ¨ ç¬¬ä¸€è½®ï¼šç”Ÿæˆåˆå§‹æ–‡æ¡ˆ
          </h3>
          <p class="text-sm"
             :class="currentStep >= 1 ? 'text-blue-700 dark:text-blue-300' : 'text-gray-400 dark:text-gray-500'">
            {{ currentStep === 1 ? 'AIæ­£åœ¨æ ¹æ®äº§å“ä¿¡æ¯å’Œé£æ ¼è¦æ±‚ç”Ÿæˆåˆå§‹æ–‡æ¡ˆ...' : currentStep > 1 ? 'âœ“ åˆå§‹æ–‡æ¡ˆç”Ÿæˆå®Œæˆ' : 'ç­‰å¾…å¼€å§‹' }}
          </p>
          <div v-if="currentStep === 1" class="mt-2 flex items-center space-x-2 text-xs text-blue-600 dark:text-blue-400">
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
            <span>é¢„è®¡è€—æ—¶ 3-5 ç§’</span>
          </div>
        </div>
      </div>

      <!-- ç¬¬äºŒæ­¥ï¼šè´¨é‡åˆ†æ -->
      <div class="flex items-start space-x-4 p-4 rounded-lg transition-all duration-300"
           :class="currentStep >= 2 ? 'bg-orange-50 dark:bg-orange-900/20 border-2 border-orange-200 dark:border-orange-700' : 'bg-gray-50 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700'">
        <div class="flex-shrink-0 mt-1">
          <div v-if="currentStep > 2" class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div v-else-if="currentStep === 2" class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center">
            <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          </div>
          <div v-else class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
            <span class="text-white font-bold">2</span>
          </div>
        </div>
        <div class="flex-1">
          <h3 class="text-base font-semibold mb-1"
              :class="currentStep >= 2 ? 'text-orange-900 dark:text-orange-200' : 'text-gray-500 dark:text-gray-400'">
            ğŸ” ç¬¬äºŒè½®ï¼šè´¨é‡åˆ†æ
          </h3>
          <p class="text-sm"
             :class="currentStep >= 2 ? 'text-orange-700 dark:text-orange-300' : 'text-gray-400 dark:text-gray-500'">
            {{ currentStep === 2 ? 'AIæ­£åœ¨åˆ†ææ–‡æ¡ˆçš„çœŸå®æ„Ÿã€çˆ†æ¬¾æ½œåŠ›å’Œå¹³å°é€‚é…æ€§...' : currentStep > 2 ? 'âœ“ è´¨é‡åˆ†æå®Œæˆï¼Œå·²è¯†åˆ«æ”¹è¿›ç‚¹' : 'ç­‰å¾…å¼€å§‹' }}
          </p>
          <div v-if="currentStep === 2" class="mt-2 flex items-center space-x-2 text-xs text-orange-600 dark:text-orange-400">
            <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
            <span>é¢„è®¡è€—æ—¶ 2-4 ç§’</span>
          </div>
        </div>
      </div>

      <!-- ç¬¬ä¸‰æ­¥ï¼šå†…å®¹ä¼˜åŒ– -->
      <div class="flex items-start space-x-4 p-4 rounded-lg transition-all duration-300"
           :class="currentStep >= 3 ? 'bg-green-50 dark:bg-green-900/20 border-2 border-green-200 dark:border-green-700' : 'bg-gray-50 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700'">
        <div class="flex-shrink-0 mt-1">
          <div v-if="currentStep > 3" class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div v-else-if="currentStep === 3" class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
            <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          </div>
          <div v-else class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
            <span class="text-white font-bold">3</span>
          </div>
        </div>
        <div class="flex-1">
          <h3 class="text-base font-semibold mb-1"
              :class="currentStep >= 3 ? 'text-green-900 dark:text-green-200' : 'text-gray-500 dark:text-gray-400'">
            âœ¨ ç¬¬ä¸‰è½®ï¼šå†…å®¹ä¼˜åŒ–
          </h3>
          <p class="text-sm"
             :class="currentStep >= 3 ? 'text-green-700 dark:text-green-300' : 'text-gray-400 dark:text-gray-500'">
            {{ currentStep === 3 ? 'AIæ­£åœ¨æ ¹æ®åˆ†æå»ºè®®ä¼˜åŒ–æ–‡æ¡ˆï¼Œæå‡è´¨é‡...' : currentStep > 3 ? 'âœ“ ä¼˜åŒ–å®Œæˆï¼æœ€ç»ˆæ–‡æ¡ˆå·²ç”Ÿæˆ' : 'ç­‰å¾…å¼€å§‹' }}
          </p>
          <div v-if="currentStep === 3" class="mt-2 flex items-center space-x-2 text-xs text-green-600 dark:text-green-400">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span>é¢„è®¡è€—æ—¶ 3-5 ç§’</span>
          </div>
        </div>
      </div>
    </div>

    <!-- å•è½®ç”Ÿæˆçš„ç®€å•åŠ è½½åŠ¨ç”» -->
    <div v-else class="flex flex-col items-center space-y-4">
      <div class="w-16 h-16 border-4 border-blue-200 dark:border-blue-800 border-t-blue-500 rounded-full animate-spin"></div>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        AIæ­£åœ¨åˆ›ä½œä¸­ï¼Œé¢„è®¡è€—æ—¶ 3-8 ç§’...
      </p>
    </div>

    <!-- æ€»è¿›åº¦æ¡ -->
    <div class="w-full max-w-2xl">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-medium text-gray-700 dark:text-gray-300">
          {{ isMultiRound ? `æ€»è¿›åº¦ï¼š${Math.round(progress)}%` : `è¿›åº¦ï¼š${Math.round(progress)}%` }}
        </span>
        <span class="text-xs text-gray-500 dark:text-gray-400">
          {{ elapsedTime }}s / {{ estimatedTime }}s
        </span>
      </div>
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
        <div 
          class="h-full rounded-full transition-all duration-500 ease-out"
          :class="isMultiRound ? 'bg-gradient-to-r from-blue-500 via-orange-500 to-green-500' : 'bg-blue-500'"
          :style="{ width: `${progress}%` }"
        ></div>
      </div>
    </div>

    <!-- æç¤ºæ–‡å­— -->
    <div class="text-center space-y-2">
      <p class="text-xs text-gray-500 dark:text-gray-400">
        ğŸ’¡ æç¤ºï¼š{{ isMultiRound ? 'å¤šè½®ä¼˜åŒ–èƒ½æ˜¾è‘—æå‡æ–‡æ¡ˆè´¨é‡' : 'é¦–æ¬¡ç”Ÿæˆå¯èƒ½éœ€è¦ç¨é•¿æ—¶é—´' }}
      </p>
      <p class="text-xs text-gray-400 dark:text-gray-500">
        è¯·ä¿æŒé¡µé¢æ‰“å¼€ï¼Œç”Ÿæˆå®Œæˆåä¼šè‡ªåŠ¨æ˜¾ç¤ºç»“æœ
      </p>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted, watch } from 'vue'

const props = defineProps({
  isMultiRound: {
    type: Boolean,
    default: false
  }
})

// å½“å‰æ­¥éª¤ (1: ç”Ÿæˆ, 2: åˆ†æ, 3: ä¼˜åŒ–, 4: å®Œæˆ)
const currentStep = ref(0)
// è¿›åº¦ç™¾åˆ†æ¯”
const progress = ref(0)
// å·²ç”¨æ—¶é—´ï¼ˆç§’ï¼‰
const elapsedTime = ref(0)
// é¢„ä¼°æ€»æ—¶é—´ï¼ˆç§’ï¼‰
const estimatedTime = computed(() => props.isMultiRound ? 15 : 8)

let timer = null
let stepTimer = null

// æ¨¡æ‹Ÿæ­¥éª¤è¿›åº¦
const simulateProgress = () => {
  // å¦‚æœæ˜¯å¤šè½®ä¼˜åŒ–ï¼Œæ¨¡æ‹Ÿä¸‰ä¸ªæ­¥éª¤
  if (props.isMultiRound) {
    // ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆï¼ˆ0-4ç§’ï¼Œè¿›åº¦0-33%ï¼‰
    setTimeout(() => {
      currentStep.value = 1
    }, 300)
    
    // ç¬¬äºŒæ­¥ï¼šåˆ†æï¼ˆ4-7ç§’ï¼Œè¿›åº¦33-66%ï¼‰
    setTimeout(() => {
      currentStep.value = 2
    }, 4000)
    
    // ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ–ï¼ˆ7-12ç§’ï¼Œè¿›åº¦66-100%ï¼‰
    setTimeout(() => {
      currentStep.value = 3
    }, 7000)
  } else {
    // å•è½®ç”Ÿæˆï¼Œç›´æ¥æ˜¾ç¤ºåŠ è½½ä¸­
    currentStep.value = 1
  }
}

// å¹³æ»‘å¢åŠ è¿›åº¦
const updateProgress = () => {
  timer = setInterval(() => {
    elapsedTime.value++
    
    // æ ¹æ®å½“å‰æ­¥éª¤æ›´æ–°è¿›åº¦ï¼Œä½†ä¿æŒåœ¨95%ä»¥ä¸‹ï¼Œé¿å…åˆ°100%ä½†è¿˜æ²¡å®Œæˆ
    if (props.isMultiRound) {
      if (currentStep.value === 1) {
        // ç¬¬ä¸€æ­¥ï¼š0-33%
        progress.value = Math.min(33, (elapsedTime.value / 4) * 33)
      } else if (currentStep.value === 2) {
        // ç¬¬äºŒæ­¥ï¼š33-66%
        progress.value = Math.min(66, 33 + ((elapsedTime.value - 4) / 3) * 33)
      } else if (currentStep.value === 3) {
        // ç¬¬ä¸‰æ­¥ï¼š66-95%
        progress.value = Math.min(95, 66 + ((elapsedTime.value - 7) / 8) * 29)
      }
    } else {
      // å•è½®ç”Ÿæˆï¼šæ¸è¿›åˆ°95%
      progress.value = Math.min(95, (elapsedTime.value / estimatedTime.value) * 95)
    }
  }, 1000)
}

// å®Œæˆè¿›åº¦ï¼ˆç”±çˆ¶ç»„ä»¶è°ƒç”¨ï¼‰
const complete = () => {
  currentStep.value = 4
  progress.value = 100
  
  if (timer) {
    clearInterval(timer)
    timer = null
  }
  if (stepTimer) {
    clearTimeout(stepTimer)
    stepTimer = null
  }
}

onMounted(() => {
  simulateProgress()
  updateProgress()
})

onUnmounted(() => {
  if (timer) {
    clearInterval(timer)
  }
  if (stepTimer) {
    clearTimeout(stepTimer)
  }
})

// æš´éœ²æ–¹æ³•ä¾›çˆ¶ç»„ä»¶è°ƒç”¨
defineExpose({
  complete
})
</script>

<style scoped>
@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</style>
